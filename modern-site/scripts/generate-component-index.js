/**
 * Build-time Component Discovery Script
 * Scans the components/industry folder structure and generates a component index
 * This enables auto-discovery of industry-specific components
 */

const fs = require('fs')
const path = require('path')

const COMPONENTS_DIR = path.join(__dirname, '../ai_builder/library/components')
const INDUSTRY_DIR = path.join(COMPONENTS_DIR, 'industry')
const OUTPUT_FILE = path.join(COMPONENTS_DIR, 'component-index.ts')

/**
 * Get all component files in a directory
 */
function getComponentsInDir(dirPath) {
  if (!fs.existsSync(dirPath)) {
    return []
  }
  
  const files = fs.readdirSync(dirPath)
  return files
    .filter(file => file.endsWith('.tsx') && !file.startsWith('_'))
    .map(file => {
      const name = file.replace('.tsx', '')
      return {
        name,
        file: file,
        path: path.join(dirPath, file).replace(process.cwd(), '').replace(/\\/g, '/')
      }
    })
}

/**
 * Discover all industry components
 */
function discoverIndustryComponents() {
  const industries = {}
  
  if (!fs.existsSync(INDUSTRY_DIR)) {
    console.warn('âš ï¸  Industry components directory not found:', INDUSTRY_DIR)
    return industries
  }
  
  const industryFolders = fs.readdirSync(INDUSTRY_DIR, { withFileTypes: true })
    .filter(dirent => dirent.isDirectory())
    .map(dirent => dirent.name)
  
  for (const industry of industryFolders) {
    const industryPath = path.join(INDUSTRY_DIR, industry)
    const components = getComponentsInDir(industryPath)
    
    if (components.length > 0) {
      industries[industry] = components.map(c => c.name)
    }
  }
  
  return industries
}

/**
 * Generate TypeScript index file
 */
function generateIndexFile(industries) {
  const industryCount = Object.keys(industries).length
  const totalComponents = Object.values(industries).reduce((sum, comps) => sum + comps.length, 0)
  
  const content = `/**
 * Auto-generated Component Index
 * Generated at build-time by scripts/generate-component-index.js
 * 
 * This file maps industries to their available components for auto-discovery.
 * 
 * Statistics:
 * - Industries: ${industryCount}
 * - Total Components: ${totalComponents}
 * 
 * DO NOT EDIT THIS FILE MANUALLY
 * Run: npm run generate:component-index
 */

export interface IndustryComponents {
  [industry: string]: string[]
}

/**
 * Industry to components mapping
 * Auto-discovered from /components/industry/{industry}/ folder structure
 */
export const industryComponents: IndustryComponents = ${JSON.stringify(industries, null, 2)}

/**
 * Get components for an industry
 */
export function getIndustryComponents(industry: string | null): string[] {
  if (!industry) return []
  
  const normalized = industry.toLowerCase().replace(/[^a-z0-9-]/g, '-')
  return industryComponents[normalized] || []
}

/**
 * Check if an industry has components
 */
export function hasIndustryComponents(industry: string | null): boolean {
  return getIndustryComponents(industry).length > 0
}

/**
 * Get all industries with components
 */
export function getIndustriesWithComponents(): string[] {
  return Object.keys(industryComponents)
}

/**
 * Get total component count for an industry
 */
export function getIndustryComponentCount(industry: string | null): number {
  return getIndustryComponents(industry).length
}
`

  return content
}

/**
 * Main execution
 */
function main() {
  console.log('ðŸ” Discovering industry components...')
  
  const industries = discoverIndustryComponents()
  const industryCount = Object.keys(industries).length
  const totalComponents = Object.values(industries).reduce((sum, comps) => sum + comps.length, 0)
  
  console.log(`âœ… Found ${industryCount} industries with ${totalComponents} total components`)
  
  const content = generateIndexFile(industries)
  
  // Ensure directory exists
  const outputDir = path.dirname(OUTPUT_FILE)
  if (!fs.existsSync(outputDir)) {
    fs.mkdirSync(outputDir, { recursive: true })
  }
  
  // Write file
  fs.writeFileSync(OUTPUT_FILE, content, 'utf-8')
  
  console.log(`âœ… Generated component index: ${OUTPUT_FILE}`)
  console.log(`ðŸ“Š Top industries by component count:`)
  
  // Show top 10 industries by component count
  const sorted = Object.entries(industries)
    .sort((a, b) => b[1].length - a[1].length)
    .slice(0, 10)
  
  sorted.forEach(([industry, components]) => {
    console.log(`   ${industry}: ${components.length} components`)
  })
}

if (require.main === module) {
  main()
}

module.exports = { discoverIndustryComponents, generateIndexFile }











